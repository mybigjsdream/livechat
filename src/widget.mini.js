import EventEmitter from"wolfy87-eventemitter";const log="development"===process.env.NODE_ENV?(...e)=>window.console.log("%cwidget%c","color: red","color: initial",...e):()=>{},WIDGET_OPEN_WIDTH=365,WIDGET_OPEN_HEIGHT=525,WIDGET_MINIMIZED_WIDTH=54,WIDGET_MINIMIZED_HEIGHT=54,WIDGET_MARGIN=16;window.RocketChat=window.RocketChat||{_:[]};const config={};let widget,iframe,bodyStyle,scrollPosition,hookQueue=[],ready=!1,smallScreen=!1;export const validCallbacks=["chat-maximized","chat-minimized","chat-started","chat-ended","pre-chat-form-submit","offline-form-submit","show-widget","hide-widget","assign-agent","agent-status-change","queue-position-change","no-agent-online"];const callbacks=new EventEmitter;function registerCallback(e,t){return-1!==validCallbacks.indexOf(e)&&callbacks.on(e,t)}function emitCallback(e,t){void 0!==t?callbacks.emit(e,t):callbacks.emit(e)}function callHook(e,t){if(!ready)return hookQueue.push([e,t]);const i={src:"rocketchat",fn:e,args:t};iframe.contentWindow.postMessage(i,"*")}const updateWidgetStyle=e=>{smallScreen&&e?(scrollPosition=document.documentElement.scrollTop,bodyStyle=document.body.style.cssText,document.body.style.cssText+=`overflow: hidden; height: 100%; width: 100%; position: fixed; top: ${scrollPosition}px;`):(document.body.style.cssText=bodyStyle,smallScreen&&(document.documentElement.scrollTop=scrollPosition)),e?(widget.style.left=smallScreen?"0":"auto",widget.style.width=smallScreen?"100%":"397px",widget.style.height=smallScreen?"100%":"627px"):(widget.style.left="auto",widget.style.width="86px",widget.style.height="86px")},createWidget=e=>{(widget=document.createElement("div")).className="rocketchat-widget",widget.style.position="fixed",widget.style.width="86px",widget.style.height="86px",widget.style.maxHeight="100vh",widget.style.bottom="0",widget.style.right="0",widget.style.zIndex="12345",widget.dataset.state="closed";const t=document.createElement("div");t.className="rocketchat-container",t.style.width="100%",t.style.height="100%",(iframe=document.createElement("iframe")).id="rocketchat-iframe",iframe.allowTransparency="true",iframe.src=e,iframe.style.width="100%",iframe.style.height="100%",iframe.style.border="none",iframe.style.backgroundColor="transparent",t.appendChild(iframe),widget.appendChild(t),document.body.appendChild(widget);const i=({matches:e})=>{widget&&(smallScreen=e,updateWidgetStyle("opened"===widget.dataset.state),callHook("setExpanded",smallScreen))},a=window.matchMedia("screen and (max-device-width: 480px)");a.addListener(i),i(a)},openWidget=()=>{"opened"!==widget.dataset.state&&(updateWidgetStyle(!0),widget.dataset.state="opened",iframe.focus(),emitCallback("chat-maximized"))};function closeWidget(){"closed"!==widget.dataset.state&&(updateWidgetStyle(!1),widget.dataset.state="closed",emitCallback("chat-minimized"))}const api={popup:null,ready(){ready=!0,hookQueue.length>0&&(hookQueue.forEach(function(e){callHook.apply(this,e)}),hookQueue=[])},minimizeWindow(){closeWidget()},restoreWindow(){api.popup&&!0!==api.popup.closed&&(api.popup.close(),api.popup=null),openWidget()},openPopout(){closeWidget(),api.popup=window.open(`${config.url}${config.url.lastIndexOf("?")>-1?"&":"?"}mode=popout`,"livechat-popout","width=365, height=525, toolbars=no"),api.popup.focus()},openWidget(){openWidget()},removeWidget(){document.body.removeChild(widget)},callback(e,t){emitCallback(e,t)},showWidget(){iframe.style.display="initial",emitCallback("show-widget")},hideWidget(){iframe.style.display="none",emitCallback("hide-widget")}};function pageVisited(e){callHook("pageVisited",{change:e,location:JSON.parse(JSON.stringify(document.location)),title:document.title})}function initialize(e){for(const t in e)switch(t){case"customField":const{key:i,value:a,overwrite:o}=e[t];setCustomField(i,a,o);continue;case"setCustomFields":if(!Array.isArray(e[t])){console.log("Error: Invalid parameters. Value must be an array of objects");continue}e[t].forEach(e=>{const{key:t,value:i,overwrite:a}=e;setCustomField(t,i,a)});continue;case"theme":setTheme(e[t]);continue;case"department":setDepartment(e[t]);continue;case"guestToken":setGuestToken(e[t]);continue;case"guestName":setGuestName(e[t]);continue;case"guestEmail":setGuestEmail(e[t]);continue;case"registerGuest":registerGuest(e[t]);continue;case"language":setLanguage(e[t]);continue;case"agent":setAgent(e[t]);continue;default:continue}}function setCustomField(e,t,i){void 0===i&&(i=!0),callHook("setCustomField",[e,t,i])}function setTheme(e){callHook("setTheme",e)}function setDepartment(e){callHook("setDepartment",e)}function setGuestToken(e){callHook("setGuestToken",e)}function setGuestName(e){callHook("setGuestName",e)}function setGuestEmail(e){callHook("setGuestEmail",e)}function registerGuest(e){callHook("registerGuest",e)}function clearDepartment(){callHook("clearDepartment")}function setAgent(e){callHook("setAgent",e)}function setLanguage(e){callHook("setLanguage",e)}function showWidget(){callHook("showWidget")}function hideWidget(){callHook("hideWidget")}function maximizeWidget(){callHook("maximizeWidget")}function minimizeWidget(){callHook("minimizeWidget")}const currentPage={href:null,title:null},attachMessageListener=()=>{window.addEventListener("message",e=>{if("object"==typeof e.data&&void 0!==e.data.src&&"rocketchat"===e.data.src&&void 0!==api[e.data.fn]&&"function"==typeof api[e.data.fn]){const t=[].concat(e.data.args||[]);log(`api.${e.data.fn}`,...t),api[e.data.fn].apply(null,t)}},!1)},trackNavigation=()=>{setInterval(()=>{document.location.href!==currentPage.href&&(pageVisited("url"),currentPage.href=document.location.href),document.title!==currentPage.title&&(pageVisited("title"),currentPage.title=document.title)},800)},init=e=>{e&&(config.url=e,createWidget(e),window.addEventListener("message",e=>{if("object"==typeof e.data&&void 0!==e.data.src&&"rocketchat"===e.data.src&&void 0!==api[e.data.fn]&&"function"==typeof api[e.data.fn]){const t=[].concat(e.data.args||[]);log(`api.${e.data.fn}`,...t),api[e.data.fn].apply(null,t)}},!1),setInterval(()=>{document.location.href!==currentPage.href&&(pageVisited("url"),currentPage.href=document.location.href),document.title!==currentPage.title&&(pageVisited("title"),currentPage.title=document.title)},800))};void 0!==window.initRocket&&(console.warn("initRocket is now deprecated. Please update the livechat code."),init(window.initRocket[0])),void 0!==window.RocketChat.url&&init(window.RocketChat.url);const queue=window.RocketChat._;window.RocketChat._.push=function(e){e.call(window.RocketChat.livechat)},window.RocketChat=window.RocketChat._.push,window.RocketChat.livechat={pageVisited:pageVisited,setCustomField:setCustomField,initialize:initialize,setTheme:setTheme,setDepartment:setDepartment,clearDepartment:clearDepartment,setGuestToken:setGuestToken,setGuestName:setGuestName,setGuestEmail:setGuestEmail,setAgent:setAgent,registerGuest:registerGuest,setLanguage:setLanguage,showWidget:showWidget,hideWidget:hideWidget,maximizeWidget:maximizeWidget,minimizeWidget:minimizeWidget,onChatMaximized(e){registerCallback("chat-maximized",e)},onChatMinimized(e){registerCallback("chat-minimized",e)},onChatStarted(e){registerCallback("chat-started",e)},onChatEnded(e){registerCallback("chat-ended",e)},onPrechatFormSubmit(e){registerCallback("pre-chat-form-submit",e)},onOfflineFormSubmit(e){registerCallback("offline-form-submit",e)},onWidgetShown(e){registerCallback("show-widget",e)},onWidgetHidden(e){registerCallback("hide-widget",e)},onAssignAgent(e){registerCallback("assign-agent",e)},onAgentStatusChange(e){registerCallback("agent-status-change",e)},onQueuePositionChange(e){registerCallback("queue-position-change",e)},onServiceOffline(e){registerCallback("no-agent-online",e)}},queue.forEach(e=>{e.call(window.RocketChat.livechat)});
